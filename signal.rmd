---
title: Plotting trees
layout: default
output: bookdown::html_chapter
---

```{r, echo=FALSE, eval=TRUE,results='hide',include=FALSE}
library("ape")
library("caper")
library("Rramas")
library("popdemo")
library("popbio")
load("data/COMADRE_v.1.0.0.RData")
```
## Signal in demographic traits {#signal}

Let's estimate signal in some demographic traits.

I will illustrate how to do this using mammals.  

Import the mammal tree. The mammalian supertree is in a Nexus file. It will be loaded as a `multiPhylo` object with 3 trees (`bestDates`, `lowerDates`, `upperDates`). I will use the `bestDates` tree.

```{r, cache=TRUE}
mammalTree <- read.nexus("data/mammalsupertree.nex")
mammalTree <- mammalTree$mammalST_bestDates
summary(mammalTree)
```

Because the COMADRE species name contains infraspecific names for some species, I first need to create a new vector in the metadata for the latin binomial. 

```{r}
comadre$metadata$binomial <- paste(comadre$metadata$GenusAccepted,"_",comadre$metadata$SpeciesEpithetAccepted,sep="")
```

Now I can check how many species in COMADRE are actually in the phylogeny...

```{r}
sum(mammalTree$tip.label %in% comadre$metadata$binomial)
```

I can also check which species are in COMADRE that are not in the phylogeny...

```{r}
COMADREmammalSp<-comadre$metadata$binomial[comadre$metadata$Class =="Mammalia"]
unique(COMADREmammalSp[which(!COMADREmammalSp %in% mammalTree$tip.label)])
```

Some of these may be synonyms and I could update the data to reflect this. Life is short though, so I'm not going to do that right now...




First, let's look at the signal for body mass.

We'll need to build a suitable data frame (this is the tricky part!) by adding weight information to the COMADRE metadata.

```{r}
pantheria <- read.delim("data/PanTHERIA_1-0_WR05_Aug2008.txt",na.strings = "-999.00")
myData <- data.frame(binomial = pantheria$MSW05_Binomial, bodyMass = pantheria$X5.1_AdultBodyMass_g)
myData$binomial <- gsub(pattern = " ",replacement = "_",myData$binomial)
#newmd <- merge(comadre$metadata,myData,by="binomial",all.x=TRUE,sort = FALSE)
#Note that the sort argument in merge() works in unexpected ways
comadre$metadata$bodyMass <- myData$bodyMass[match(comadre$metadata$binomial,myData$binomial)]
```

Now we need to subset the whole COMADRE object to only include the data in the tree, and where we have body mass information. In practice it is best to make a `comparative.data` object. This type of object combines both the data and the tree in a single object. It is best to subset the data to include only the columns you are interested in before making it.

```{r}
#first make a body mass data.frame.
tempData <- unique(comadre$metadata[,c("binomial","bodyMass")])
bmCompData<-comparative.data(mammalTree,tempData,names.col = "binomial")
```

Now I can fit a PGLS to estimate signal strength.

```{r,cache=TRUE}
model1<-pgls(log(bodyMass)~1,data = bmCompData,lambda="ML")
summary(model1)
plot(pgls.profile(model1))
```

One can address particular matrices in COMADRE (or COMPADRE) using the indexing functionality (square brackets).

```{r}
comadre$mat[[24]]$matA
```

Let's take a look at the signal strength for damping ratio - the speed of convergence to the stable age distribution. There is a function for this in both the `popbio` and `popdemo` packages. I will use the `popbio` version.

```{r,eval = FALSE, include=TRUE ,results='hide'}
for(i in 1:nrow(comadre$metadata)){
  A <-comadre$mat[[i]]$matA
  comadre$metadata$dampingRatio[i]<-as.numeric(try(damping.ratio(A)))
}
```

```{r,eval = TRUE, include=FALSE ,results='hide'}
for(i in 1:nrow(comadre$metadata)){
  A <-comadre$mat[[i]]$matA
  comadre$metadata$dampingRatio[i]<-as.numeric(try(damping.ratio(A)))
}
```

```{r,eval = TRUE, include=TRUE ,results='hide',cache=TRUE}
hist(log(comadre$metadata$dampingRatio))
```

Let's now estimate signal in the damping ratio. Where there are more than one record per species I will take the mean.


```{r}
tempData <- comadre$metadata[,c("binomial","dampingRatio")]
x<-tapply(tempData$dampingRatio,tempData$binomial,mean)
tempData<-data.frame(binomial = names(x), dampingRatio= as.vector(x))
```

Some of the damping ratios are calculated to be infinite. I replace these with NA.

```{r}
tempData$dampingRatio[tempData$dampingRatio == Inf] <- NA
drCompData<-comparative.data(mammalTree,tempData,names.col = "binomial")
```

Now I can fit a PGLS model to estimate signal strength in damping ratio.

```{r}
model1<-pgls(log(dampingRatio)~1,data = drCompData,lambda="ML")
summary(model1)
```

This measure has a really low signal! This means that it would be extremely difficult to infer the value based on the value of similar species.

## Try the same thing for reactivity {#reactivity}

Reactivity is the first-timestep amplification which tells how fast a population could possibly grow (see Ezard et al.).

Again, I will loop through the matrices in COMADRE, then subset to the species of interest...

```{r,eval = FALSE, include=TRUE ,results='hide'}
for(i in 1:nrow(comadre$metadata)){
  A <-comadre$mat[[i]]$matA
  comadre$metadata$react[i]<-as.numeric(try(reactivity(A)))
}
```

```{r,eval = TRUE, include=FALSE ,results='hide'}
for(i in 1:nrow(comadre$metadata)){
  A <-comadre$mat[[i]]$matA
  comadre$metadata$react[i]<-as.numeric(try(reactivity(A)))
}
```

```{r,eval = TRUE, include=TRUE ,results='hide',cache=TRUE}
hist(log(comadre$metadata$react))
```

Now I can estimate signal in reactivity. As before, where there is more than one record per species I will take the mean.


```{r}
tempData <- comadre$metadata[,c("binomial","react")]
x<-tapply(tempData$react,tempData$binomial,mean)
tempData<-data.frame(binomial = names(x), react= as.vector(x))

reactCompData<-comparative.data(mammalTree,tempData,names.col = "binomial")
```

Now I can fit a PGLS model to estimate signal strength in reactivity I can also look at the likelihood surface for the lambda (signal) estimate.
 
```{r,cache=TRUE}
model1<-pgls(log(react)~1,data = reactCompData,lambda="ML")
summary(model1)
plot(pgls.profile(model1))
```

This measure also has a really low signal! 

The question is, are there demographic traits with high signal? Can signal be useful?

